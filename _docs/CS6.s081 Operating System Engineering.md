---
title: "MIT 6.s081 Operating System Engineering"
excerpt: "MIT 6.s081 ä½œä¸ºè‘—åçš„æ“ä½œç³»ç»Ÿå¯¼è®ºçº§è¯¾ç¨‹ï¼Œå¯¹äºŽæ“ä½œç³»ç»Ÿçš„è®¾è®¡å’Œå®žçŽ°ï¼Œä»¥åŠå®ƒä»¬ä½œä¸ºç³»ç»Ÿç¼–ç¨‹åŸºç¡€çš„ä½¿ç”¨æœ‰ç€éžå¸¸ç‹¬åˆ°è€Œæ˜“æ‡‚çš„è®²è§£ã€‚"
collection: docs
---

# å‰è¨€ï¼ˆIntro)

â€‹	MIT 6.s081 ä½œä¸ºè‘—åçš„æ“ä½œç³»ç»Ÿå¯¼è®ºçº§è¯¾ç¨‹ï¼Œå¯¹äºŽæ“ä½œç³»ç»Ÿçš„è®¾è®¡å’Œå®žçŽ°ï¼Œä»¥åŠå®ƒä»¬ä½œä¸ºç³»ç»Ÿç¼–ç¨‹åŸºç¡€çš„ä½¿ç”¨æœ‰ç€éžå¸¸ç‹¬åˆ°è€Œæ˜“æ‡‚çš„è®²è§£ã€‚åœ¨ç»“æŸè®¡ç®—æœºä½“ç³»ç»“æž„åŸºç¡€çš„ç²—æµ…å­¦ä¹ åŽï¼Œç¬”è€…æ¯«ä¸çŠ¹è±«åœ°é€‰æ‹©äº†å®ƒå¼€å§‹äº†å¯¹ä½œä¸ºè®¡ç®—æœºä¸‰å¤§æµªæ¼«ä¹‹ä¸€çš„OSçš„åˆæ­¥å­¦ä¹ ã€‚

â€‹	åœ¨Fall2020çš„ç‰ˆæœ¬ä¸­ï¼Œlectureçš„ä¸»é¢˜åŒ…æ‹¬è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿã€çº¿ç¨‹ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€å†…æ ¸ã€ä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨ã€è¿›ç¨‹é—´é€šä¿¡ã€è½¯ä»¶å’Œç¡¬ä»¶ä¹‹é—´çš„åè°ƒå’Œäº¤äº’ç­‰ç­‰ï¼›è€Œå¯¹äºŽlabï¼Œè¿™é—¨è¯¾ä¸“é—¨å¼€å‘äº†ä¸€ä¸ªæ–°çš„åŸºäºŽ RISC-V çš„æ•™å­¦ç”¨å¤šå¤„ç†å™¨æ“ä½œç³»ç»Ÿ xv6ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äºŽ Unix v6 çš„æ“ä½œç³»ç»Ÿï¼Œè€Œä¸æ˜¯æœ€æ–°æœ€å¥½ç‰ˆæœ¬çš„ Linuxã€Windows æˆ– BSD Unixï¼Œä½† xv6è¶³å¤Ÿå¤§ï¼Œè¶³ä»¥è¯´æ˜Žæ“ä½œç³»ç»Ÿä¸­çš„åŸºæœ¬è®¾è®¡å’Œå®žçŽ°æ€æƒ³ã€‚å¦ä¸€æ–¹é¢ï¼Œxv6 æ¯”ä»»ä½•çŽ°ä»£ç”Ÿäº§æ“ä½œç³»ç»Ÿéƒ½è¦å°å¾—å¤šï¼Œå› æ­¤ä¹Ÿæ›´å®¹æ˜“ç†è§£ã€‚ xv6 å…·æœ‰ä¸Žè®¸å¤šçŽ°ä»£æ“ä½œç³»ç»Ÿç±»ä¼¼çš„ç»“æž„ï¼Œåœ¨æŽ¢ç´¢xv6çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šå‘çŽ° Linux ç­‰å†…æ ¸å†…éƒ¨æœ‰å¾ˆå¤šç†Ÿæ‚‰çš„å†…å®¹ã€‚

![MIT](../images/MIT.png)

# ç®€ä»‹(Synopsis)

## Lab æŒ‡å¼•

å®˜æ–¹éš¾åº¦å‚è€ƒï¼š
ðŸŸ© easyï¼šå°äºŽ 1 å°æ—¶ã€‚é€šå¸¸æ˜¯ä¸ºåŽç»­ç»ƒä¹ çš„çƒ­èº«
ðŸŸ§ moderateï¼š1ï½ž2 å°æ—¶ã€‚é€šå¸¸æ˜¯æ·»åŠ ä¸€äº›è¾ƒä¸ºç‹¬ç«‹çš„æ‹“å±•
ðŸŸ¥ hardï¼šå¤§äºŽ 2 å°æ—¶ï¼Œé€šå¸¸è¿™äº›åŠŸèƒ½çš„å®žçŽ°ä¸éœ€è¦å†™å¾ˆå¤šè¡Œä»£ç ï¼Œ ä½†æ˜¯debugçš„è·¯é€”æ¯”è¾ƒåŽå·

â€œä¸ªäººè€—æ—¶â€æ˜¯æˆ‘ä¸ªäººåœ¨åšè¿™ä¸ª lab çš„æ—¶å€™æ‰€ç”¨çš„æ—¶é—´ï¼ŒåŒ…å«äº†ç ”ç©¶ã€é˜…è¯»ä»£ç ã€ç¼–ç ä¸Žè°ƒè¯•å…¨è¿‡ç¨‹ã€‚

#### **Lab1 - Xv6 and Unix utilitiesï½œUnix å®žç”¨å·¥å…·ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** å®žçŽ°å‡ ä¸ªç”¨æˆ·æ€ç¨‹åºåŠ unix å®žç”¨å·¥å…·ï¼Œç†Ÿæ‚‰ xv6 çš„å¼€å‘çŽ¯å¢ƒä»¥åŠç³»ç»Ÿè°ƒç”¨çš„ä½¿ç”¨ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ©ðŸŸ© 2 easy, ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ 4 moderate
**ä¸ªäººè€—æ—¶ï¼š** 7 å°æ—¶ 

##### Boot xv6 ðŸŸ©

å‡†å¤‡çŽ¯å¢ƒï¼Œç¼–è¯‘ç¼–è¯‘å™¨ã€QEMUï¼Œå…‹éš†ä»“åº“

```bash
$ git clone git://g.csail.mit.edu/xv6-labs-2020
$ cd xv6-labs-2020
$ git checkout util
$ make qemu
```

##### sleep ðŸŸ©

æ·»åŠ ä¸€ä¸ªself-writtençš„sleep.cæ–‡ä»¶æ‰§è¡Œç”¨æˆ·çº§çš„è¿›ç¨‹ï¼Œè°ƒç”¨user.hä¸­æä¾›çš„syscallæŽ¥å£å³å¯

##### pingpong ðŸŸ§

ç®¡é“ç»ƒæ‰‹é¢˜ï¼Œä½¿ç”¨ fork() å¤åˆ¶çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºä¸¤ä¸ªç®¡é“ï¼Œåˆ†åˆ«ç”¨äºŽçˆ¶å­ä¹‹é—´ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®ä¼ è¾“å³å¯

##### primes ðŸŸ§

è®¾è®¡ä¸€ä¸ªé€’å½’çš„filterï¼Œæ¯ä¸€ä¸ª stage ä»¥å½“å‰æ•°é›†ä¸­æœ€å°çš„æ•°å­—ä½œä¸ºç´ æ•°è¾“å‡ºï¼ˆæ¯ä¸ª stage ä¸­æ•°é›†ä¸­æœ€å°çš„æ•°ä¸€å®šæ˜¯ä¸€ä¸ªç´ æ•°ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«ä»»ä½•æ¯”å®ƒå°çš„æ•°ç­›æŽ‰ï¼‰ï¼Œå¹¶ç­›æŽ‰è¾“å…¥ä¸­è¯¥ç´ æ•°çš„æ‰€æœ‰å€æ•°ï¼ˆå¿…ç„¶ä¸æ˜¯ç´ æ•°ï¼‰ï¼Œç„¶åŽå°†å‰©ä¸‹çš„æ•°ä¼ é€’ç»™ä¸‹ä¸€ stageã€‚æœ€åŽä¼šå½¢æˆä¸€æ¡å­è¿›ç¨‹é“¾ï¼Œè€Œç”±äºŽæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½è°ƒç”¨äº†wait(0)ç­‰å¾…å…¶å­è¿›ç¨‹ï¼Œæ‰€ä»¥ä¼šåœ¨æœ€æœ«ç«¯ä¹Ÿå°±æ˜¯æœ€åŽä¸€ä¸ª stage å®Œæˆçš„æ—¶å€™ï¼Œæ²¿ç€é“¾æ¡å‘ä¸Šä¾æ¬¡é€€å‡ºå„ä¸ªè¿›ç¨‹ã€‚

**æ³¨æ„ï¼šç”±äºŽæ¯ä¸ªstage ä¹‹é—´ä¼šæœ‰ä¸¤ä¸ªç®¡é“ pleft å’Œ prightï¼Œè¦æ³¨æ„å…³é—­ä¸éœ€è¦ç”¨åˆ°çš„æ–‡ä»¶æè¿°ç¬¦**

##### find ðŸŸ§

æœ¬è´¨ä¸Šå°±æ˜¯åœ¨lsçš„åŸºç¡€ä¸Šè¿›è¡Œäº†é€‰æ‹©ï¼Œæ‰€ä»¥å¯ä»¥ä»¿ç…§ls.cè¿›è¡Œæ”¹é€ ï¼Œé€»è¾‘ä¸Šå…ˆæ‰“å¼€ç»™å®špathçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ£€æŸ¥å®ƒçš„æ–‡ä»¶çŠ¶æ€ï¼Œæ˜¯æ–‡ä»¶åˆ™æ£€æŸ¥ä¸Žtargetæ˜¯å¦ç›¸åŒï¼Œæ˜¯ç›®å½•åˆ™é€’å½’æœç´¢å†…éƒ¨æ–‡ä»¶

##### xargs ðŸŸ§

ç¼–å†™ xargs å·¥å…·ï¼Œä»Žæ ‡å‡†è¾“å…¥è¯»å…¥æ•°æ®ï¼Œå°†æ¯ä¸€è¡Œå½“ä½œå‚æ•°ï¼ŒåŠ å…¥åˆ°ä¼ ç»™ xargs çš„ç¨‹åºåå’Œå‚æ•°åŽé¢ä½œä¸ºé¢å¤–å‚æ•°ï¼Œç„¶åŽæ‰§è¡Œã€‚ç”¨å†…å­˜æ± å°†å‚¨å­˜è°ƒç”¨xargçš„å‚æ•°ä»¥åŠä»Žstdinè¯»å…¥çš„å‚æ•°ï¼Œå¯¹æ¯ä¸ªå‘½ä»¤éƒ½forkå‡ºå­è¿›ç¨‹execå³å¯

#### **Lab2 - System callsï½œç³»ç»Ÿè°ƒç”¨ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** æ·»åŠ  syscall è·Ÿè¸ªï¼Œä»¥åŠæ·»åŠ æ–°çš„ç³»ç»Ÿè°ƒç”¨ sysinfoï¼Œå¸®åŠ©åŠ æ·±å¯¹ xv6 å†…æ ¸çš„ç†è§£ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ§ðŸŸ§ 2 moderate
**ä¸ªäººè€—æ—¶ï¼š** 6 å°æ—¶

##### System call tracing ðŸŸ§

ä¸ºtraceè¿™ä¸ªç”¨æˆ·ç¨‹åºæ·»åŠ ä¸€ä¸ªå†…æ ¸å‡½æ•°åŠå…¶æŽ¥å£ã€‚é¦–å…ˆåœ¨å†…æ ¸ä¸­çš„sysproc.cä¸­å®žçŽ°å†…æ ¸è°ƒç”¨ï¼Œç„¶åŽåœ¨syscall.hä¸­åŠ å…¥æ–° sys_traceçš„åºå·ï¼ŒæŽ¥ç€ç”¨ extern å…¨å±€å£°æ˜Žæ–°çš„å†…æ ¸è°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”åœ¨ syscalls æ˜ å°„è¡¨ä¸­ï¼ŒåŠ å…¥ä»Žå‰é¢å®šä¹‰çš„ç¼–å·åˆ°ç³»ç»Ÿè°ƒç”¨å‡½æ•°æŒ‡é’ˆçš„æ˜ å°„ï¼Œæ­¤å¤–è¿˜éœ€è¦åœ¨ usys.pl ä¸­åŠ å…¥ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è·³æ¿å‡½æ•°ï¼Œæœ€åŽåœ¨user.hä¸­åŠ å…¥å®šä¹‰ï¼Œå³å¯ä½¿ç”¨æˆ·æ€ç¨‹åºæ‰¾åˆ°è¿™ä¸ªè·³æ¿å…¥å£å‡½æ•°ã€‚

##### Sysinfo ðŸŸ§

æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿”å›žç©ºé—²çš„å†…å­˜ã€ä»¥åŠå·²åˆ›å»ºçš„è¿›ç¨‹æ•°é‡ã€‚

xv6 ä¸­ï¼Œç©ºé—²å†…å­˜é¡µçš„è®°å½•æ–¹å¼æ˜¯ï¼Œå°†ç©ºè™šå†…å­˜é¡µ**æœ¬èº«**ç›´æŽ¥ç”¨ä½œé“¾è¡¨èŠ‚ç‚¹ï¼Œå½¢æˆä¸€ä¸ªç©ºé—²é¡µé“¾è¡¨ï¼Œæ¯æ¬¡éœ€è¦åˆ†é…ï¼Œå°±æŠŠé“¾è¡¨æ ¹éƒ¨å¯¹åº”çš„é¡µåˆ†é…å‡ºåŽ»ã€‚æ¯æ¬¡éœ€è¦å›žæ”¶ï¼Œå°±æŠŠè¿™ä¸ªé¡µä½œä¸ºæ–°çš„æ ¹èŠ‚ç‚¹ï¼ŒæŠŠåŽŸæ¥çš„ freelist é“¾è¡¨æŽ¥åˆ°åŽé¢ã€‚æ‰€ä»¥è®¡ç®—ç©ºé—²å†…å­˜å°±åªéœ€è¦é€ä¸ªæ£€æŸ¥freelistçš„ç»“ç‚¹ç„¶åŽåŠ ä¸Špagesizeå³å¯

è¿›ç¨‹æ•°ç›®åˆ™å¯ä»¥ç›´æŽ¥é€šè¿‡å†…æ ¸æ ˆä¸Šç»´æŠ¤çš„procæ•°ç»„ï¼Œé€ä¸ªæŸ¥è¯¢proc->stateçš„çŠ¶æ€è®¡æ•°å³å¯ã€‚å‰©ä¸‹çš„syscallå®žçŽ°ä¸Žä¸Šé¢ä¸€è‡´

#### **Lab3 - Page tablesï½œé¡µè¡¨ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** æŽ¢ç´¢é¡µè¡¨ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨ï¼›ä¿®æ”¹é¡µè¡¨ä»¥ç®€åŒ–ä»Žç”¨æˆ·æ€æ‹·è´æ•°æ®åˆ°å†…æ ¸æ€çš„æ–¹æ³•ã€‚
ï¼ˆéš¾ç‚¹ï¼šç†è§£è¿›ç¨‹é¡µè¡¨ã€å†…æ ¸é¡µè¡¨æ¦‚å¿µï¼‰
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ© 1 easy, ðŸŸ¥ðŸŸ¥ 2 hard
**ä¸ªäººè€—æ—¶ï¼š** 26 å°æ—¶

##### Print a page table ðŸŸ©

æ·»åŠ ä¸€ä¸ªæ‰“å°é¡µè¡¨çš„å†…æ ¸å‡½æ•°ï¼ŒæŒ‰ç»™å®šæ ¼å¼æ‰“å°å‡ºä¼ è¿›çš„é¡µè¡¨ã€‚

ç”±äºŽRISC-V çš„é€»è¾‘åœ°å€å¯»å€æ˜¯é‡‡ç”¨ä¸‰çº§é¡µè¡¨çš„å½¢å¼ï¼Œ9 bit ä¸€çº§ç´¢å¼•æ‰¾åˆ°äºŒçº§é¡µè¡¨ï¼Œ9 bit äºŒçº§ç´¢å¼•æ‰¾åˆ°ä¸‰çº§é¡µè¡¨ï¼Œ9 bit ä¸‰çº§ç´¢å¼•æ‰¾åˆ°å†…å­˜é¡µï¼Œæœ€ä½Ž 12 bit ä¸ºé¡µå†…åç§»ï¼ˆå³ä¸€ä¸ªé¡µ 4096 bytesï¼‰ï¼Œæ‰€ä»¥è¦é€’å½’æ‰“å°é¡µè¡¨ï¼Œåªéœ€è¦å°†é€’å½’é‡Šæ”¾é¡µè¡¨çš„å‡½æ•° freewalk()å¤åˆ¶ä¸€ä»½å¹¶å°†é‡Šæ”¾éƒ¨åˆ†ä»£ç æ”¹ä¸ºæ‰“å°å³å¯

##### A kernel page table per processðŸŸ¥

xv6 åŽŸæœ¬çš„è®¾è®¡æ˜¯ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ç”¨æˆ·æ€ä½¿ç”¨å„è‡ªçš„ç”¨æˆ·æ€é¡µè¡¨ï¼Œä½†æ˜¯ä¸€æ—¦è¿›å…¥å†…æ ¸æ€ï¼ˆä¾‹å¦‚ä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œåˆ™åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼ˆé€šè¿‡ä¿®æ”¹ satp å¯„å­˜å™¨ï¼Œtrampoline.Sï¼‰ã€‚ç„¶è€Œè¿™ä¸ªå†…æ ¸é¡µè¡¨æ˜¯å…¨å±€å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨è¿›ç¨‹è¿›å…¥å†…æ ¸æ€éƒ½å…±ç”¨åŒä¸€ä¸ªå†…æ ¸æ€é¡µè¡¨ï¼Œæœ¬æ‹“å±•åˆ™æ˜¯è¦æ±‚è®©æ¯ä¸€ä¸ªè¿›ç¨‹è¿›å…¥å†…æ ¸æ€åŽï¼Œéƒ½èƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹**å†…æ ¸é¡µè¡¨**

é¦–å…ˆåœ¨è¿›ç¨‹çš„ç»“æž„ä½“ proc ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª kernelpgtblï¼Œç”¨äºŽå­˜å‚¨è¿›ç¨‹ä¸“äº«çš„å†…æ ¸æ€é¡µè¡¨ã€‚æŽ¥ä¸‹æ¥æš´æ”¹ kvminitã€‚å†…æ ¸éœ€è¦ä¾èµ–å†…æ ¸é¡µè¡¨å†…ä¸€äº›å›ºå®šçš„æ˜ å°„çš„å­˜åœ¨æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œä¾‹å¦‚ UART æŽ§åˆ¶ã€ç¡¬ç›˜ç•Œé¢ã€ä¸­æ–­æŽ§åˆ¶ç­‰ã€‚è€Œ kvminit åŽŸæœ¬åªä¸ºå…¨å±€å†…æ ¸é¡µè¡¨ kernel_pagetable æ·»åŠ è¿™äº›æ˜ å°„ã€‚æˆ‘ä»¬æŠ½è±¡å‡ºæ¥ä¸€ä¸ªå¯ä»¥ä¸ºä»»ä½•æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å†…æ ¸é¡µè¡¨æ·»åŠ è¿™äº›æ˜ å°„çš„å‡½æ•° kvm_map_pagetable()ã€‚

çŽ°åœ¨å¯ä»¥åˆ›å»ºè¿›ç¨‹é—´ç›¸äº’ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿éœ€è¦å¤„ç†ï¼šå†…æ ¸æ ˆã€‚ åŽŸæœ¬çš„ xv6 è®¾è®¡ä¸­ï¼Œæ‰€æœ‰å¤„äºŽå†…æ ¸æ€çš„è¿›ç¨‹éƒ½å…±äº«åŒä¸€ä¸ªé¡µè¡¨ï¼Œå³æ„å‘³ç€å…±äº«åŒä¸€ä¸ªåœ°å€ç©ºé—´ã€‚ç”±äºŽ xv6 æ”¯æŒå¤šæ ¸/å¤šè¿›ç¨‹è°ƒåº¦ï¼ŒåŒä¸€æ—¶é—´å¯èƒ½ä¼šæœ‰å¤šä¸ªè¿›ç¨‹å¤„äºŽå†…æ ¸æ€ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ‰€æœ‰å¤„äºŽå†…æ ¸æ€çš„è¿›ç¨‹åˆ›å»ºå…¶ç‹¬ç«‹çš„å†…æ ¸æ€å†…çš„æ ˆï¼Œä¹Ÿå°±æ˜¯å†…æ ¸æ ˆï¼Œä¾›ç»™å…¶å†…æ ¸æ€ä»£ç æ‰§è¡Œè¿‡ç¨‹ã€‚

xv6 åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨ procinit() ä¸­ä¸ºæ‰€æœ‰å¯èƒ½çš„ 64 ä¸ªè¿›ç¨‹ä½éƒ½é¢„åˆ†é…å¥½å†…æ ¸æ ˆ kstackï¼Œå…·ä½“ä¸ºåœ¨é«˜åœ°å€ç©ºé—´é‡Œï¼Œæ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªé¡µä½œä¸º kstackï¼Œå¹¶ä¸”ä¸¤ä¸ªä¸åŒ kstack ä¸­é—´éš”ç€ä¸€ä¸ªæ— æ˜ å°„çš„ guard page ç”¨äºŽæ£€æµ‹æ ˆæº¢å‡ºé”™è¯¯ã€‚å…·ä½“å‚è€ƒ [xv6 book](https://pdos.csail.mit.edu/6.S081/2020/xv6/book-riscv-rev1.pdf) çš„ Figure 3.3ã€‚

åœ¨ xv6 åŽŸæ¥çš„è®¾è®¡ä¸­ï¼Œå†…æ ¸é¡µè¡¨æœ¬æ¥æ˜¯åªæœ‰ä¸€ä¸ªçš„ï¼Œæ‰€æœ‰è¿›ç¨‹å…±ç”¨ï¼Œæ‰€ä»¥éœ€è¦ä¸ºä¸åŒè¿›ç¨‹åˆ›å»ºå¤šä¸ªå†…æ ¸æ ˆï¼Œå¹¶ map åˆ°ä¸åŒä½ç½®ï¼ˆè§ `procinit()` å’Œ `KSTACK` å®ï¼‰ã€‚è€Œæˆ‘ä»¬çš„æ–°è®¾è®¡ä¸­ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨ï¼Œå¹¶ä¸”æ¯ä¸ªè¿›ç¨‹ä¹Ÿåªéœ€è¦è®¿é—®è‡ªå·±çš„å†…æ ¸æ ˆï¼Œè€Œä¸éœ€è¦èƒ½å¤Ÿè®¿é—®æ‰€æœ‰ 64 ä¸ªè¿›ç¨‹çš„å†…æ ¸æ ˆã€‚æ‰€ä»¥å¯ä»¥å°†æ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸æ ˆ map åˆ°å…¶**å„è‡ªå†…æ ¸é¡µè¡¨å†…çš„å›ºå®šä½ç½®**ï¼ˆä¸åŒé¡µè¡¨å†…çš„åŒä¸€é€»è¾‘åœ°å€ï¼ŒæŒ‡å‘ä¸åŒç‰©ç†å†…å­˜ï¼‰ã€‚

ç„¶åŽï¼Œåœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ºè¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨ï¼Œä»¥åŠå†…æ ¸æ ˆ

åˆ°è¿™é‡Œè¿›ç¨‹ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨å°±åˆ›å»ºå®Œæˆäº†ï¼Œä½†æ˜¯ç›®å‰åªæ˜¯åˆ›å»ºè€Œå·²ï¼Œç”¨æˆ·è¿›ç¨‹è¿›å…¥å†…æ ¸æ€åŽä¾ç„¶ä¼šä½¿ç”¨å…¨å±€å…±äº«çš„å†…æ ¸é¡µè¡¨ï¼Œå› æ­¤è¿˜éœ€è¦åœ¨ scheduler() ä¸­è¿›è¡Œç›¸å…³ä¿®æ”¹ã€‚åœ¨è°ƒåº¦å™¨å°† CPU äº¤ç»™è¿›ç¨‹æ‰§è¡Œä¹‹å‰ï¼Œåˆ‡æ¢åˆ°è¯¥è¿›ç¨‹å¯¹åº”çš„å†…æ ¸é¡µè¡¨ï¼š

åˆ°è¿™é‡Œï¼Œæ¯ä¸ªè¿›ç¨‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±éƒ½ä¼šåœ¨å†…æ ¸æ€é‡‡ç”¨è‡ªå·±ç‹¬ç«‹çš„å†…æ ¸é¡µè¡¨äº†ã€‚æœ€åŽéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯åœ¨è¿›ç¨‹ç»“æŸåŽï¼Œåº”è¯¥é‡Šæ”¾è¿›ç¨‹ç‹¬äº«çš„é¡µè¡¨ä»¥åŠå†…æ ¸æ ˆï¼Œå›žæ”¶èµ„æºï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

##### Simplify copyin/copyinstr ðŸŸ¥

åœ¨ä¸Šä¸€ä¸ªå®žéªŒä¸­ï¼Œå·²ç»ä½¿å¾—æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„å†…æ ¸æ€é¡µè¡¨äº†ï¼Œè¿™ä¸ªå®žéªŒçš„ç›®æ ‡æ˜¯ï¼Œåœ¨è¿›ç¨‹çš„å†…æ ¸æ€é¡µè¡¨ä¸­ç»´æŠ¤ä¸€ä¸ªç”¨æˆ·æ€é¡µè¡¨æ˜ å°„çš„å‰¯æœ¬ï¼Œè¿™æ ·ä½¿å¾—å†…æ ¸æ€ä¹Ÿå¯ä»¥å¯¹ç”¨æˆ·æ€ä¼ è¿›æ¥çš„æŒ‡é’ˆï¼ˆé€»è¾‘åœ°å€ï¼‰è¿›è¡Œè§£å¼•ç”¨ã€‚è¿™æ ·åšç›¸æ¯”åŽŸæ¥ copyin çš„å®žçŽ°çš„ä¼˜åŠ¿æ˜¯ï¼ŒåŽŸæ¥çš„ copyin æ˜¯é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿè®¿é—®é¡µè¡¨çš„è¿‡ç¨‹èŽ·å–ç‰©ç†åœ°å€çš„ï¼Œè€Œåœ¨å†…æ ¸é¡µè¡¨å†…ç»´æŠ¤æ˜ å°„å‰¯æœ¬çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ CPU çš„ç¡¬ä»¶å¯»å€åŠŸèƒ½è¿›è¡Œå¯»å€ï¼Œæ•ˆçŽ‡æ›´é«˜å¹¶ä¸”å¯ä»¥å—å¿«è¡¨åŠ é€Ÿã€‚

è¦å®žçŽ°è¿™æ ·çš„æ•ˆæžœï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸€å¤„å†…æ ¸å¯¹ç”¨æˆ·é¡µè¡¨è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œå°†åŒæ ·çš„ä¿®æ”¹ä¹ŸåŒæ­¥åº”ç”¨åœ¨è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨ä¸Šï¼Œä½¿å¾—ä¸¤ä¸ªé¡µè¡¨çš„ç¨‹åºæ®µï¼ˆ0 åˆ° PLIC æ®µï¼‰åœ°å€ç©ºé—´çš„æ˜ å°„åŒæ­¥ã€‚

é¦–å…ˆå®žçŽ°ä¸€äº›å·¥å…·æ–¹æ³•ï¼Œkvmcopymappings()å°† src é¡µè¡¨çš„ä¸€éƒ¨åˆ†é¡µæ˜ å°„å…³ç³»æ‹·è´åˆ° dst é¡µè¡¨ä¸­ï¼Œå¹¶ä¸”åªæ‹·è´é¡µè¡¨é¡¹ï¼Œä¸æ‹·è´å®žé™…çš„ç‰©ç†é¡µå†…å­˜ï¼›kvmdealloc()ç”¨äºŽåŒæ­¥é‡Šæ”¾å†…å­˜æ—¶å†…æ ¸é¡µè¡¨å†…ç¨‹åºå†…å­˜çš„æ˜ å°„å’Œç”¨æˆ·é¡µè¡¨ç¨‹åºå†…å­˜çš„æ˜ å°„ï¼Œä¸Ž uvmdealloc åŠŸèƒ½ç±»ä¼¼ï¼Œå°†ç¨‹åºå†…å­˜ä»Ž oldsz ç¼©å‡åˆ° newszã€‚ä½†åŒºåˆ«åœ¨äºŽä¸é‡Šæ”¾å®žé™…å†…å­˜

æŽ¥ä¸‹æ¥ï¼Œä¸ºæ˜ å°„ç¨‹åºå†…å­˜åšå‡†å¤‡ã€‚å®žéªŒä¸­æç¤ºå†…æ ¸å¯åŠ¨åŽï¼Œèƒ½å¤Ÿç”¨äºŽæ˜ å°„ç¨‹åºå†…å­˜çš„åœ°å€èŒƒå›´æ˜¯ [0,PLIC)ï¼Œæˆ‘ä»¬å°†æŠŠè¿›ç¨‹ç¨‹åºå†…å­˜æ˜ å°„åˆ°å…¶å†…æ ¸é¡µè¡¨çš„è¿™ä¸ªèŒƒå›´å†…ï¼Œé¦–å…ˆè¦ç¡®ä¿è¿™ä¸ªèŒƒå›´æ²¡æœ‰å’Œå…¶ä»–æ˜ å°„å†²çªã€‚æ‰€ä»¥ä¿®æ”¹ kvm_map_pagetable()ï¼ŒåŽ»é™¤ CLINT çš„æ˜ å°„ï¼Œè¿™æ ·è¿›ç¨‹å†…æ ¸é¡µè¡¨å°±ä¸ä¼šæœ‰ CLINT ä¸Žç¨‹åºå†…å­˜æ˜ å°„å†²çªçš„é—®é¢˜ã€‚ä½†æ˜¯ç”±äºŽå…¨å±€å†…æ ¸é¡µè¡¨ä¹Ÿä½¿ç”¨äº† kvm_map_pagetable() è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”å†…æ ¸å¯åŠ¨çš„æ—¶å€™éœ€è¦ CLINT æ˜ å°„å­˜åœ¨ï¼Œæ•…åœ¨ kvminit() ä¸­ï¼Œå¦å¤–å•ç‹¬ç»™å…¨å±€å†…æ ¸é¡µè¡¨æ˜ å°„ CLINTã€‚

åŽé¢çš„æ­¥éª¤å°±æ˜¯åœ¨æ¯ä¸ªä¿®æ”¹åˆ°è¿›ç¨‹ç”¨æˆ·é¡µè¡¨çš„ä½ç½®ï¼Œéƒ½å°†ç›¸åº”çš„ä¿®æ”¹åŒæ­¥åˆ°è¿›ç¨‹å†…æ ¸é¡µè¡¨ä¸­ã€‚ä¸€å…±è¦ä¿®æ”¹ï¼šfork()ã€exec()ã€growproc()ã€userinit()ã€‚æœ€åŽæ›¿æ¢copyinã€copyinstrçš„å®žçŽ°å³å¯

#### **Lab4 - Trapsï½œä¸­æ–­é™·é˜±ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** æŽ¢ç´¢ä¸­æ–­ä»¥åŠä¸­æ–­å¤„ç†æœºåˆ¶ï¼ˆtrapã€trampolineã€å‡½æ•°è°ƒç”¨ã€çŽ°åœºä¿å­˜ã€é¡µè¡¨/ç‰¹æƒåˆ‡æ¢ã€è°ƒç”¨æ ˆã€æ ˆæŒ‡é’ˆåŠè¿”å›žæŒ‡é’ˆï¼‰
ï¼ˆæ³¨ï¼šæœ¬ lab å¹¶ä¸éžå¸¸éš¾ï¼Œé‡è¦çš„æ˜¯ç†è§£ lecture5 ä¸Ž lecture6 ä¸­çš„æ¦‚å¿µï¼‰
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ© 1 easy, ðŸŸ§ 1 moderate, ðŸŸ¥ 1 hard
**ä¸ªäººè€—æ—¶ï¼š** 4 å°æ—¶

#### RISC-V assembly ðŸŸ©

é˜…è¯» call.asmï¼Œä»¥åŠ RISC-V æŒ‡ä»¤é›†æ•™ç¨‹ï¼Œå›žç­”é—®é¢˜

##### Backtrace ðŸŸ§ 

åœ¨å†…æ ¸ä¸­çš„sys_sleepå‡½æ•°è°ƒç”¨ä¸­æ·»åŠ  backtrace åŠŸèƒ½ï¼Œæ‰“å°å‡ºè°ƒç”¨æ ˆï¼Œç”¨äºŽè°ƒè¯•ã€‚é¦–å…ˆåœ¨åœ¨ defs.h ä¸­æ·»åŠ å£°æ˜Žï¼Œç„¶åŽåœ¨ riscv.h ä¸­æ·»åŠ èŽ·å–å½“å‰ fpï¼ˆframe pointerï¼‰å¯„å­˜å™¨çš„æ–¹æ³•ï¼ŒæŽ¥ç€åœ¨printf.cä¸­å®žçŽ° backtrace å‡½æ•°ï¼Œæœ€åŽåœ¨ sys_sleep çš„å¼€å¤´è°ƒç”¨ä¸€æ¬¡ backtrace()å³å¯

å…³é”®æ˜¯å¦‚ä½•èŽ·å–å½“å‰ fpï¼ˆframe pointerï¼‰å¯„å­˜å™¨ï¼Œå…³äºŽå¯„å­˜å™¨ã€æ ˆå¸§ä»¥åŠå†…å­˜è°ƒç”¨çš„ç»†èŠ‚ï¼Œå¯ä»¥æŸ¥çœ‹ [lecture 5](https://pdos.csail.mit.edu/6.S081/2020/lec/l-riscv.txt)

##### Alarm ðŸŸ¥

ä¸º xv6 æ·»åŠ ä¸€é¡¹åŠŸèƒ½ï¼Œåœ¨è¿›ç¨‹å ç”¨ CPU æ—¶é—´æ—¶å®šæœŸå‘å‡ºè­¦æŠ¥ã€‚è¿™å¯èƒ½å¯¹å¸Œæœ›é™åˆ¶å ç”¨ CPU æ—¶é—´çš„è®¡ç®—ç»‘å®šè¿›ç¨‹ï¼Œæˆ–å¸Œæœ›è®¡ç®—ä½†ä¹Ÿå¸Œæœ›é‡‡å–æŸäº›å®šæœŸè¡ŒåŠ¨çš„è¿›ç¨‹å¾ˆæœ‰ç”¨ã€‚æ›´ä¸€èˆ¬åœ°è¯´ï¼Œå®ƒå°†å®žçŽ°ä¸€ç§åŽŸå§‹å½¢å¼çš„ç”¨æˆ·çº§ä¸­æ–­/æ•…éšœå¤„ç†ç¨‹åºï¼Œä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„æ–¹æ³•æ¥å¤„ç†åº”ç”¨ç¨‹åºä¸­çš„page fault

é¦–å…ˆï¼Œåœ¨ proc ç»“æž„ä½“çš„å®šä¹‰ä¸­ï¼Œå¢žåŠ  alarm ç›¸å…³å­—æ®µï¼š

- alarm_intervalï¼šæ—¶é’Ÿå‘¨æœŸï¼Œ0 ä¸ºç¦ç”¨
- alarm_handlerï¼šæ—¶é’Ÿå›žè°ƒå¤„ç†å‡½æ•°
- alarm_ticksï¼šä¸‹ä¸€æ¬¡æ—¶é’Ÿå“èµ·å‰è¿˜å‰©ä¸‹çš„ ticks æ•°
- alarm_trapframeï¼šæ—¶é’Ÿä¸­æ–­æ—¶åˆ»çš„ trapframeï¼Œç”¨äºŽä¸­æ–­å¤„ç†å®ŒæˆåŽæ¢å¤åŽŸç¨‹åºçš„æ­£å¸¸æ‰§è¡Œ
- alarm_goingoffï¼šæ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªæ—¶é’Ÿå›žè°ƒæ­£åœ¨æ‰§è¡Œä¸”è¿˜æœªè¿”å›žï¼ˆç”¨äºŽé˜²æ­¢åœ¨ alarm_handler ä¸­é€”é—¹é’Ÿåˆ°æœŸå†æ¬¡è°ƒç”¨ alarm_handlerï¼Œå¯¼è‡´ alarm_trapframe è¢«è¦†ç›–ï¼‰

ç„¶åŽæ·»åŠ ç³»ç»Ÿè°ƒç”¨sys_sigalarmå’Œsys_sigreturnï¼Œå…¶ä¸­sigalarmè®¾ç½® myproc ä¸­çš„ç›¸å…³å±žæ€§ï¼Œsigreturnå°†trapframeæ¢å¤åˆ°æ—¶é’Ÿä¸­æ–­ä¹‹å‰çš„çŠ¶æ€ï¼Œæ¢å¤åŽŸæœ¬æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºæµã€‚æŽ¥ç€åœ¨ proc.c ä¸­çš„allocprocå’Œfreeprocæ·»åŠ åˆå§‹åŒ–ä¸Žé‡Šæ”¾ä»£ç 

æœ€åŽåœ¨ usertrap() å‡½æ•°ä¸­ï¼Œå®žçŽ°æ—¶é’Ÿæœºåˆ¶å…·ä½“ä»£ç ï¼Œè¿™æ ·ï¼Œåœ¨æ¯æ¬¡æ—¶é’Ÿä¸­æ–­çš„æ—¶å€™ï¼Œå¦‚æžœè¿›ç¨‹æœ‰å·²ç»è®¾ç½®çš„æ—¶é’Ÿï¼ˆ`alarm_interval != 0`ï¼‰ï¼Œåˆ™è¿›è¡Œ alarm_ticks å€’æ•°ã€‚å½“ alarm_ticks å€’æ•°åˆ°å°äºŽç­‰äºŽ 0 çš„æ—¶å€™ï¼Œå¦‚æžœæ²¡æœ‰æ­£åœ¨å¤„ç†çš„æ—¶é’Ÿï¼Œåˆ™å°è¯•è§¦å‘æ—¶é’Ÿï¼Œå°†åŽŸæœ¬çš„ç¨‹åºæµä¿å­˜èµ·æ¥ï¼ˆ`*alarm_trapframe = *trapframe`ï¼‰ï¼Œç„¶åŽé€šè¿‡ä¿®æ”¹ pc å¯„å­˜å™¨çš„å€¼ï¼Œå°†ç¨‹åºæµè½¬è·³åˆ° alarm_handler ä¸­ï¼Œalarm_handler æ‰§è¡Œå®Œæ¯•åŽå†æ¢å¤åŽŸæœ¬çš„æ‰§è¡Œæµï¼ˆ`*trapframe = *alarm_trapframe`ï¼‰ã€‚è¿™æ ·ä»ŽåŽŸæœ¬ç¨‹åºæ‰§è¡Œæµçš„è§†è§’ï¼Œå°±æ˜¯ä¸å¯æ„ŸçŸ¥çš„ä¸­æ–­äº†ã€‚

#### **Lab5 - Lazy allocationï½œå†…å­˜é¡µæ‡’åˆ†é…ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** å®žçŽ°å†…å­˜é¡µæ‡’åˆ†é…æœºåˆ¶ï¼Œåœ¨è°ƒç”¨ sbrk() çš„æ—¶å€™ï¼Œä¸ç«‹å³åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯åªä½œè®°å½•ã€‚åœ¨è®¿é—®åˆ°è¿™ä¸€éƒ¨åˆ†å†…å­˜é¡µå¹¶è§¦å‘ç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™æ‰è¿›è¡Œå®žé™…çš„ç‰©ç†å†…å­˜åˆ†é…ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ© 1 easy, ðŸŸ§ 2 moderate
**ä¸ªäººè€—æ—¶ï¼š** 4 å°æ—¶ 

##### Eliminate allocation from sbrk() ðŸŸ© 

ä¿®æ”¹ sys_sbrkï¼Œä½¿å…¶ä¸å†è°ƒç”¨ growproc()ï¼Œè€Œæ˜¯åªä¿®æ”¹ p->sz çš„å€¼è€Œä¸åˆ†é…ç‰©ç†å†…å­˜å³å¯

##### Lazy allocation ðŸŸ§

ä¿®æ”¹ usertrap ç”¨æˆ·æ€ trap å¤„ç†å‡½æ•°ï¼Œä¸ºç¼ºé¡µå¼‚å¸¸æ·»åŠ æ£€æµ‹ï¼Œå¦‚æžœä¸ºç¼ºé¡µå¼‚å¸¸ï¼ˆ`(r_scause() == 13 || r_scause() == 15)`ï¼‰ï¼Œä¸”å‘ç”Ÿå¼‚å¸¸çš„åœ°å€æ˜¯ç”±äºŽæ‡’åˆ†é…è€Œæ²¡æœ‰æ˜ å°„çš„è¯ï¼Œå°±ä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¹¶åœ¨é¡µè¡¨å»ºç«‹æ˜ å°„

åœ¨å®žçŽ°uvmlazytouchå‡½æ•°æ¥è´Ÿè´£åˆ†é…å®žé™…çš„ç‰©ç†å†…å­˜å¹¶å»ºç«‹æ˜ å°„ä¹‹å‰ï¼Œè¿˜éœ€è¦å®žçŽ°uvmshouldtouchç”¨äºŽæ£€æµ‹ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ˜¯ä¸æ˜¯ä¸€ä¸ªéœ€è¦è¢« touch çš„æ‡’åˆ†é…å†…å­˜åœ°å€ï¼Œå…·ä½“æ£€æµ‹çš„æ˜¯ï¼š

1. å¤„äºŽ `[0, p->sz)`åœ°å€èŒƒå›´ä¹‹ä¸­ï¼ˆè¿›ç¨‹ç”³è¯·çš„å†…å­˜èŒƒå›´ï¼‰
2. ä¸æ˜¯æ ˆçš„ guard pageï¼ˆå…·ä½“è§ xv6 bookï¼Œæ ˆé¡µçš„ä½Žä¸€é¡µæ•…æ„ç•™æˆä¸æ˜ å°„ï¼Œä½œä¸ºå“¨å…µç”¨äºŽæ•æ‰ stack overflow é”™è¯¯ã€‚æ‡’åˆ†é…ä¸åº”è¯¥ç»™è¿™ä¸ªåœ°å€åˆ†é…ç‰©ç†é¡µå’Œå»ºç«‹æ˜ å°„ï¼Œè€Œåº”è¯¥ç›´æŽ¥æŠ›å‡ºå¼‚å¸¸ï¼‰
   ï¼ˆè§£å†³ usertests ä¸­çš„ stacktest å¤±è´¥çš„é—®é¢˜ï¼‰
3. é¡µè¡¨é¡¹ä¸å­˜åœ¨

ç”±äºŽæ‡’åˆ†é…çš„é¡µï¼Œåœ¨åˆšåˆ†é…çš„æ—¶å€™æ˜¯æ²¡æœ‰å¯¹åº”çš„æ˜ å°„çš„ï¼Œæ‰€ä»¥è¦æŠŠä¸€äº›åŽŸæœ¬åœ¨é‡åˆ°æ— æ˜ å°„åœ°å€æ—¶ä¼š panic çš„å‡½æ•°çš„è¡Œä¸ºæ”¹ä¸ºç›´æŽ¥å¿½ç•¥è¿™æ ·çš„åœ°å€ï¼š

- uvmummap()ï¼šå–æ¶ˆè™šæ‹Ÿåœ°å€æ˜ å°„

- uvmcopy()ï¼šå°†çˆ¶è¿›ç¨‹çš„é¡µè¡¨ä»¥åŠå†…å­˜æ‹·è´åˆ°å­è¿›ç¨‹

- copyin() å’Œ copyout()ï¼šå†…æ ¸/ç”¨æˆ·æ€ä¹‹é—´äº’ç›¸æ‹·è´æ•°æ®

ç”±äºŽè¿™é‡Œå¯èƒ½ä¼šè®¿é—®åˆ°æ‡’åˆ†é…ä½†æ˜¯è¿˜æ²¡å®žé™…åˆ†é…çš„é¡µï¼Œæ‰€ä»¥è¦åŠ ä¸€ä¸ªæ£€æµ‹ï¼Œç¡®ä¿ copy ä¹‹å‰ï¼Œç”¨æˆ·æ€åœ°å€å¯¹åº”çš„é¡µéƒ½æœ‰è¢«å®žé™…åˆ†é…å’Œæ˜ å°„ã€‚

##### Lazytests and Usertests ðŸŸ§

æä¾›äº†ä¸€äº›ç‰¹å®šçš„æµ‹è¯•ç”¨ä¾‹ï¼š

1. Handle negative sbrk() arguments.
2. Kill a process if it page-faults on a virtual memory address higher than any allocated with sbrk().
3. Handle the parent-to-child memory copy in fork() correctly.
4. Handle the case in which a process passes a valid address from sbrk() to a system call such as read or write, but the memory for that address has not yet been allocated.
5. Handle out-of-memory correctly: if kalloc() fails in the page fault handler, kill the current process.
6. Handle faults on the invalid page below the user stack.

#### **Lab6 - Copy-on-write forkï½œfork æ‡’æ‹·è´ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** å®žçŽ° fork æ‡’å¤åˆ¶æœºåˆ¶ï¼Œåœ¨è¿›ç¨‹ fork åŽï¼Œä¸Žçˆ¶è¿›ç¨‹å…±äº«ç‰©ç†å†…å­˜é¡µã€‚åœ¨ä»»ä¸€æ–¹å°è¯•å¯¹å†…å­˜é¡µè¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ‰å¯¹å†…å­˜é¡µè¿›è¡Œå¤åˆ¶ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ¥ 1 hard
**ä¸ªäººè€—æ—¶ï¼š** 5 å°æ—¶ 

##### Implement copy-on write ðŸŸ¥

å®žçŽ° fork æ‡’å¤åˆ¶æœºåˆ¶ï¼Œåœ¨è¿›ç¨‹ fork åŽï¼Œä¸ç«‹åˆ»å¤åˆ¶å†…å­˜é¡µï¼Œè€Œæ˜¯å°†è™šæ‹Ÿåœ°å€æŒ‡å‘ä¸Žçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†åœ°å€ã€‚åœ¨çˆ¶å­ä»»æ„ä¸€æ–¹å°è¯•å¯¹å†…å­˜é¡µè¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ‰å¯¹å†…å­˜é¡µè¿›è¡Œå¤åˆ¶ã€‚ ç‰©ç†å†…å­˜é¡µå¿…é¡»ä¿è¯åœ¨æ‰€æœ‰å¼•ç”¨éƒ½æ¶ˆå¤±åŽæ‰èƒ½è¢«é‡Šæ”¾ï¼Œè¿™é‡Œéœ€è¦æœ‰å¼•ç”¨è®¡æ•°æœºåˆ¶ã€‚

é¦–å…ˆä¿®æ”¹ uvmcopy()ï¼Œåœ¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜åˆ°å­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ç«‹åˆ»å¤åˆ¶æ•°æ®ï¼Œè€Œæ˜¯å»ºç«‹æŒ‡å‘åŽŸç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶å°†çˆ¶å­ä¸¤ç«¯çš„é¡µè¡¨é¡¹éƒ½è®¾ç½®ä¸ºä¸å¯å†™ã€‚ç„¶åŽä¸Ž lazy allocation lab ç±»ä¼¼ï¼Œåœ¨ usertrap() ä¸­æ·»åŠ å¯¹ page fault çš„æ£€æµ‹ï¼Œå¹¶åœ¨å½“å‰è®¿é—®çš„åœ°å€ç¬¦åˆæ‡’å¤åˆ¶é¡µæ¡ä»¶æ—¶ï¼Œå¯¹æ‡’å¤åˆ¶é¡µè¿›è¡Œå®žå¤åˆ¶æ“ä½œï¼›åŒæ—¶ copyout() ç”±äºŽæ˜¯è½¯ä»¶è®¿é—®é¡µè¡¨ï¼Œä¸ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æ·»åŠ åŒæ ·çš„ç›‘æµ‹ä»£ç ï¼ˆåŒ lab5ï¼‰ï¼Œæ£€æµ‹æŽ¥æ”¶çš„é¡µæ˜¯å¦æ˜¯ä¸€ä¸ªæ‡’å¤åˆ¶é¡µï¼Œè‹¥æ˜¯ï¼Œæ‰§è¡Œå®žå¤åˆ¶æ“ä½œã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦åœ¨vm.cä¸­å®žçŽ°æ‡’å¤åˆ¶é¡µçš„æ£€æµ‹ï¼ˆ`uvmcheckcowpage()`ï¼‰ä¸Žå®žå¤åˆ¶ï¼ˆ`uvmcowcopy()`ï¼‰æ“ä½œ

åˆ°è¿™é‡Œï¼Œå°±å·²ç»ç¡®å®šäº†å¤§ä½“çš„é€»è¾‘äº†ï¼šåœ¨ fork çš„æ—¶å€™ä¸å¤åˆ¶æ•°æ®åªå»ºç«‹æ˜ å°„+æ ‡è®°ï¼Œåœ¨è¿›ç¨‹å°è¯•å†™å…¥çš„æ—¶å€™è¿›è¡Œå®žå¤åˆ¶å¹¶é‡æ–°æ˜ å°„ä¸ºå¯å†™ã€‚æŽ¥ä¸‹æ¥ï¼Œè¿˜éœ€è¦åšé¡µçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è¿›ç¨‹éƒ½ä¸ä½¿ç”¨ä¸€ä¸ªé¡µæ—¶æ‰å°†å…¶é‡Šæ”¾

åœ¨åŽŸæœ¬çš„ xv6 å®žçŽ°ä¸­ï¼Œä¸€ä¸ªç‰©ç†é¡µçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œå¯ä»¥æ”¯æŒä»¥ä¸‹æ“ä½œï¼š

- kalloc(): åˆ†é…ç‰©ç†é¡µ
- kfree(): é‡Šæ”¾å›žæ”¶ç‰©ç†é¡µ

è€Œåœ¨æ”¯æŒäº†æ‡’åˆ†é…åŽï¼Œç”±äºŽä¸€ä¸ªç‰©ç†é¡µå¯èƒ½è¢«å¤šä¸ªè¿›ç¨‹ï¼ˆå¤šä¸ªè™šæ‹Ÿåœ°å€ï¼‰å¼•ç”¨ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æœ€åŽä¸€ä¸ªå¼•ç”¨æ¶ˆå¤±åŽæ‰å¯ä»¥é‡Šæ”¾å›žæ”¶è¯¥ç‰©ç†é¡µï¼Œæ‰€ä»¥ä¸€ä¸ªç‰©ç†é¡µçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼ŒçŽ°åœ¨éœ€è¦æ”¯æŒä»¥ä¸‹æ“ä½œï¼š

- kalloc(): åˆ†é…ç‰©ç†é¡µï¼Œå°†å…¶å¼•ç”¨è®¡æ•°ç½®ä¸º 1
- krefpage(): åˆ›å»ºç‰©ç†é¡µçš„ä¸€ä¸ªæ–°å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°åŠ  1
- kcopy_n_deref(): å°†ç‰©ç†é¡µçš„ä¸€ä¸ªå¼•ç”¨å®žå¤åˆ¶åˆ°ä¸€ä¸ªæ–°ç‰©ç†é¡µä¸Šï¼ˆå¼•ç”¨è®¡æ•°ä¸º 1ï¼‰ï¼Œè¿”å›žå¾—åˆ°çš„å‰¯æœ¬é¡µï¼›å¹¶å°†æœ¬ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°å‡ 1
- kfree(): é‡Šæ”¾ç‰©ç†é¡µçš„ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°å‡ 1ï¼›å¦‚æžœè®¡æ•°å˜ä¸º 0ï¼Œåˆ™é‡Šæ”¾å›žæ”¶ç‰©ç†é¡µ

ä¸€ä¸ªç‰©ç†é¡µ p é¦–å…ˆä¼šè¢«çˆ¶è¿›ç¨‹ä½¿ç”¨ kalloc() åˆ›å»ºï¼Œfork çš„æ—¶å€™ï¼Œæ–°åˆ›å»ºçš„å­è¿›ç¨‹ä¼šä½¿ç”¨ krefpage() å£°æ˜Žè‡ªå·±å¯¹çˆ¶è¿›ç¨‹ç‰©ç†é¡µçš„å¼•ç”¨ã€‚å½“å°è¯•ä¿®æ”¹çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹ä¸­çš„é¡µæ—¶ï¼Œkcopy_n_deref() è´Ÿè´£å°†æƒ³è¦ä¿®æ”¹çš„é¡µå®žå¤åˆ¶åˆ°ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå¹¶è®°å½•è§£é™¤æ—§çš„ç‰©ç†é¡µçš„å¼•ç”¨ï¼ˆå¼•ç”¨è®¡æ•°å‡ 1ï¼‰ã€‚æœ€åŽ kfree() ä¿è¯åªæœ‰åœ¨æ‰€æœ‰çš„å¼•ç”¨è€…éƒ½é‡Šæ”¾è¯¥ç‰©ç†é¡µçš„å¼•ç”¨æ—¶ï¼Œæ‰é‡Šæ”¾å›žæ”¶è¯¥ç‰©ç†é¡µå³å¯

#### **Lab7 - Multithreadingï½œå¤šçº¿ç¨‹ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** å®žçŽ°ä¸€ä¸ªç”¨æˆ·æ€çš„çº¿ç¨‹åº“ï¼›å°è¯•ä½¿ç”¨çº¿ç¨‹æ¥ä¸ºç¨‹åºæé€Ÿï¼›å®žçŽ°ä¸€ä¸ªåŒæ­¥å±éšœ
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ§ðŸŸ§ðŸŸ§ 3 moderate
**ä¸ªäººè€—æ—¶ï¼š** 4 å°æ—¶

##### Uthread: switching between threads ðŸŸ§

å®žçŽ°ä¸€ä¸ªç”¨æˆ·æ€çš„çº¿ç¨‹åº“ï¼Œè¡¥å…¨ uthread.cï¼Œå®Œæˆç”¨æˆ·æ€çº¿ç¨‹åŠŸèƒ½çš„å®žçŽ°ã€‚è¿™ä¸ªå®žéªŒå…¶å®žç›¸å½“äºŽåœ¨ç”¨æˆ·æ€é‡æ–°å®žçŽ°ä¸€é xv6 kernel ä¸­çš„ scheduler() å’Œ swtch() çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¤§å¤šæ•°ä»£ç éƒ½æ˜¯å¯ä»¥å€Ÿé‰´çš„ã€‚

uthread_switch.S ä¸­éœ€è¦å®žçŽ°ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ç ï¼Œè¿™é‡Œå€Ÿé‰´ swtch.Sï¼›ä»Ž proc.h ä¸­å€Ÿé‰´ä¸€ä¸‹ context ç»“æž„ä½“ï¼Œç”¨äºŽä¿å­˜ raã€sp ä»¥åŠ callee-saved registersï¼›åœ¨ thread_schedule ä¸­è°ƒç”¨ thread_switch è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼›å†è¡¥é½ thread_createï¼Œæ·»åŠ çš„éƒ¨åˆ†ä¸ºè®¾ç½®ä¸Šä¸‹æ–‡ä¸­ ra æŒ‡å‘çš„åœ°å€ä¸ºçº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œè¿™æ ·åœ¨ç¬¬ä¸€æ¬¡è°ƒåº¦åˆ°è¯¥çº¿ç¨‹ï¼Œæ‰§è¡Œåˆ° thread_switch ä¸­çš„ ret ä¹‹åŽå°±å¯ä»¥è·³è½¬åˆ°çº¿ç¨‹å‡½æ•°ä»Žè€Œå¼€å§‹æ‰§è¡Œäº†ã€‚è®¾ç½® sp ä½¿å¾—çº¿ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬æœ‰çš„æ ˆï¼Œä¹Ÿå°±æ˜¯ç‹¬ç«‹çš„æ‰§è¡Œæµã€‚

##### Using threads ðŸŸ§

åˆ†æžå¹¶è§£å†³ä¸€ä¸ªå“ˆå¸Œè¡¨æ“ä½œçš„ä¾‹å­å†…ï¼Œç”±äºŽ race-condition å¯¼è‡´çš„æ•°æ®ä¸¢å¤±çš„é—®é¢˜

å•çº¯åœ¨putå’Œgetä¸­åŠ é”åŽå¤šçº¿ç¨‹çš„æ€§èƒ½åè€Œå˜å¾—æ¯”å•çº¿ç¨‹è¿˜è¦ä½Žäº†ï¼Œè™½ç„¶ä¸ä¼šå‡ºçŽ°æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯å¤±åŽ»äº†å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—çš„æ„ä¹‰ï¼šæå‡æ€§èƒ½ã€‚è¿™é‡Œçš„åŽŸå› æ˜¯ï¼Œæˆ‘ä»¬ä¸ºæ•´ä¸ªæ“ä½œåŠ ä¸Šäº†äº’æ–¥é”ï¼Œæ„å‘³ç€æ¯ä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œå“ˆå¸Œè¡¨ï¼Œè¿™é‡Œå®žé™…ä¸Šç­‰åŒäºŽå°†å“ˆå¸Œè¡¨çš„æ“ä½œå˜å›žå•çº¿ç¨‹äº†ï¼Œåˆç”±äºŽé”æ“ä½œï¼ˆåŠ é”ã€è§£é”ã€é”ç«žäº‰ï¼‰æ˜¯æœ‰å¼€é”€çš„ï¼Œæ‰€ä»¥æ€§èƒ½ç”šè‡³ä¸å¦‚å•çº¿ç¨‹ç‰ˆæœ¬ã€‚

è¿™é‡Œçš„ä¼˜åŒ–æ€è·¯ï¼Œä¹Ÿæ˜¯å¤šçº¿ç¨‹æ•ˆçŽ‡çš„ä¸€ä¸ªå¸¸è§çš„ä¼˜åŒ–æ€è·¯ï¼Œå°±æ˜¯é™ä½Žé”çš„ç²’åº¦ã€‚ç”±äºŽå“ˆå¸Œè¡¨ä¸­ï¼Œä¸åŒçš„ bucket æ˜¯äº’ä¸å½±å“çš„ï¼Œä¸€ä¸ª bucket å¤„äºŽä¿®æ”¹æœªå®Œå…¨çš„çŠ¶æ€å¹¶ä¸å½±å“ put å’Œ get å¯¹å…¶ä»– bucket çš„æ“ä½œï¼Œæ‰€ä»¥å®žé™…ä¸Šåªéœ€è¦ç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹ä¸ä¼šåŒæ—¶æ“ä½œåŒä¸€ä¸ª bucket å³å¯ï¼Œå¹¶ä¸éœ€è¦ç¡®ä¿ä¸ä¼šåŒæ—¶æ“ä½œæ•´ä¸ªå“ˆå¸Œè¡¨ã€‚

æ‰€ä»¥å¯ä»¥å°†åŠ é”çš„ç²’åº¦ï¼Œä»Žæ•´ä¸ªå“ˆå¸Œè¡¨ä¸€ä¸ªé”é™ä½Žåˆ°æ¯ä¸ª bucket ä¸€ä¸ªé”å³å¯

##### Barrier ðŸŸ§

åˆ©ç”¨ pthread æä¾›çš„æ¡ä»¶å˜é‡æ–¹æ³•ï¼Œå®žçŽ°[åŒæ­¥å±éšœæœºåˆ¶](https://en.wikipedia.org/wiki/Barrier_(computer_science))ã€‚

çº¿ç¨‹è¿›å…¥åŒæ­¥å±éšœ barrier æ—¶ï¼Œå°†å·²è¿›å…¥å±éšœçš„çº¿ç¨‹æ•°é‡å¢žåŠ  1ï¼Œç„¶åŽå†åˆ¤æ–­æ˜¯å¦å·²ç»è¾¾åˆ°æ€»çº¿ç¨‹æ•°ã€‚å¦‚æžœæœªè¾¾åˆ°ï¼Œåˆ™è¿›å…¥ç¡çœ ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚å¦‚æžœå·²ç»è¾¾åˆ°ï¼Œåˆ™å”¤é†’æ‰€æœ‰åœ¨ barrier ä¸­ç­‰å¾…çš„çº¿ç¨‹ï¼Œæ‰€æœ‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼›å±éšœè½®æ•° + 1ï¼›

ã€Œå°†å·²è¿›å…¥å±éšœçš„çº¿ç¨‹æ•°é‡å¢žåŠ  1ï¼Œç„¶åŽå†åˆ¤æ–­æ˜¯å¦å·²ç»è¾¾åˆ°æ€»çº¿ç¨‹æ•°ã€è¿™ä¸€æ­¥å¹¶ä¸æ˜¯åŽŸå­æ“ä½œï¼Œå¹¶ä¸”è¿™ä¸€æ­¥å’ŒåŽé¢çš„ä¸¤ç§æƒ…å†µä¸­çš„æ“ä½œã€Œç¡çœ ã€å’Œã€Œå”¤é†’ã€ä¹‹é—´ä¹Ÿä¸æ˜¯åŽŸå­çš„ï¼Œå¦‚æžœåœ¨è¿™é‡Œå‘ç”Ÿ race-conditionï¼Œåˆ™ä¼šå¯¼è‡´å‡ºçŽ° ã€Œlost wake-up é—®é¢˜ã€ï¼ˆçº¿ç¨‹ 1 å³å°†ç¡çœ å‰ï¼Œçº¿ç¨‹ 2 è°ƒç”¨äº†å”¤é†’ï¼Œç„¶åŽçº¿ç¨‹ 1 æ‰è¿›å…¥ç¡çœ ï¼Œå¯¼è‡´çº¿ç¨‹ 1 æœ¬è¯¥è¢«å”¤é†’è€Œæ²¡è¢«å”¤é†’ï¼Œè¯¦è§ [xv6 book](https://pdos.csail.mit.edu/6.S081/2020/xv6/book-riscv-rev1.pdf) ä¸­çš„ç¬¬ 72 é¡µï¼ŒSleep and wakeupï¼‰

è§£å†³æ–¹æ³•æ˜¯ï¼Œã€Œå±éšœçš„çº¿ç¨‹æ•°é‡å¢žåŠ  1ï¼›åˆ¤æ–­æ˜¯å¦å·²ç»è¾¾åˆ°æ€»çº¿ç¨‹æ•°ï¼›è¿›å…¥ç¡çœ ã€è¿™ä¸‰æ­¥å¿…é¡»åŽŸå­ã€‚æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªäº’æ–¥é” barrier_mutex æ¥ä¿æŠ¤è¿™ä¸€éƒ¨åˆ†ä»£ç ã€‚pthread_cond_wait ä¼šåœ¨è¿›å…¥ç¡çœ çš„æ—¶å€™åŽŸå­æ€§çš„é‡Šæ”¾ barrier_mutexï¼Œä»Žè€Œå…è®¸åŽç»­çº¿ç¨‹è¿›å…¥ barrierï¼Œé˜²æ­¢æ­»é”ã€‚

#### **Lab8 - Parallelism/Lockingï½œå¹¶å‘ä¸Žé”ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** é‡æ–°è®¾è®¡å¹¶å‘ä»£ç ä»¥é™ä½Žé”ç«žäº‰ï¼Œæé«˜åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šçš„æ€§èƒ½ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ§ 1 moderate, ðŸŸ¥ 1 hard
**ä¸ªäººè€—æ—¶ï¼š** 8 å°æ—¶ 

##### Memory allocator ðŸŸ§

é€šè¿‡æ‹†åˆ† kmem ä¸­çš„ç©ºé—²å†…å­˜é“¾è¡¨ï¼Œé™ä½Ž kalloc å®žçŽ°ä¸­çš„ kmem é”ç«žäº‰ã€‚

kalloc åŽŸæœ¬çš„å®žçŽ°ä¸­ï¼Œä½¿ç”¨ freelist é“¾è¡¨ï¼Œå°†ç©ºé—²ç‰©ç†é¡µ**æœ¬èº«**ç›´æŽ¥ç”¨ä½œé“¾è¡¨é¡¹ï¼ˆè¿™æ ·å¯ä»¥ä¸ä½¿ç”¨é¢å¤–ç©ºé—´ï¼‰è¿žæŽ¥æˆä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨åˆ†é…çš„æ—¶å€™ï¼Œå°†ç‰©ç†é¡µä»Žé“¾è¡¨ä¸­ç§»é™¤ï¼Œå›žæ”¶æ—¶å°†ç‰©ç†é¡µæ”¾å›žé“¾è¡¨ä¸­ã€‚åœ¨è¿™é‡Œæ— è®ºæ˜¯åˆ†é…ç‰©ç†é¡µæˆ–é‡Šæ”¾ç‰©ç†é¡µï¼Œéƒ½éœ€è¦ä¿®æ”¹ freelist é“¾è¡¨ã€‚ç”±äºŽä¿®æ”¹æ˜¯å¤šæ­¥æ“ä½œï¼Œä¸ºäº†ä¿æŒå¤šçº¿ç¨‹ä¸€è‡´æ€§ï¼Œå¿…é¡»åŠ é”ã€‚ä½†è¿™æ ·çš„è®¾è®¡ä¹Ÿä½¿å¾—å¤šçº¿ç¨‹æ— æ³•å¹¶å‘ç”³è¯·å†…å­˜ï¼Œé™åˆ¶äº†å¹¶å‘æ•ˆçŽ‡ã€‚

è¿™é‡Œè§£å†³æ€§èƒ½çƒ­ç‚¹çš„æ€è·¯æ˜¯ã€Œå°†å…±äº«èµ„æºå˜ä¸ºä¸å…±äº«èµ„æºã€ã€‚é”ç«žäº‰ä¼˜åŒ–ä¸€èˆ¬æœ‰å‡ ä¸ªæ€è·¯ï¼š

- åªåœ¨å¿…é¡»å…±äº«çš„æ—¶å€™å…±äº«ï¼ˆå¯¹åº”ä¸ºå°†èµ„æºä»Ž CPU å…±äº«æ‹†åˆ†ä¸ºæ¯ä¸ª CPU ç‹¬ç«‹ï¼‰
- å¿…é¡»å…±äº«æ—¶ï¼Œå°½é‡å‡å°‘åœ¨å…³é”®åŒºä¸­åœç•™çš„æ—¶é—´ï¼ˆå¯¹åº”â€œå¤§é”åŒ–å°é”â€ï¼Œé™ä½Žé”çš„ç²’åº¦ï¼‰

è¯¥ lab çš„å®žéªŒç›®æ ‡ï¼Œå³æ˜¯ä¸ºæ¯ä¸ª CPU åˆ†é…ç‹¬ç«‹çš„ freelistï¼Œè¿™æ ·å¤šä¸ª CPU å¹¶å‘åˆ†é…ç‰©ç†é¡µå°±ä¸å†ä¼šäº’ç›¸æŽ’æ–¥äº†ï¼Œæé«˜äº†å¹¶è¡Œæ€§ã€‚

ä½†ç”±äºŽåœ¨ä¸€ä¸ª CPU freelist ä¸­ç©ºé—²é¡µä¸è¶³çš„æƒ…å†µä¸‹ï¼Œä»éœ€è¦ä»Žå…¶ä»– CPU çš„ freelist ä¸­â€œå·â€å†…å­˜é¡µï¼Œæ‰€ä»¥ä¸€ä¸ª CPU çš„ freelist å¹¶ä¸æ˜¯åªä¼šè¢«å…¶å¯¹åº” CPU è®¿é—®ï¼Œè¿˜å¯èƒ½åœ¨â€œå·â€å†…å­˜é¡µçš„æ—¶å€™è¢«å…¶ä»– CPU è®¿é—®ï¼Œæ•…ä»ç„¶éœ€è¦ä½¿ç”¨å•ç‹¬çš„é”æ¥ä¿æŠ¤æ¯ä¸ª CPU çš„ freelistã€‚ä½†ä¸€ä¸ª CPU freelist ä¸­ç©ºé—²é¡µä¸è¶³çš„æƒ…å†µç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒç¨€æœ‰çš„ï¼Œæ‰€ä»¥æ€»ä½“æ€§èƒ½ä¾ç„¶æ¯”å•ç‹¬ kmem å¤§é”è¦å¿«ã€‚åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿè·¨ CPU â€œå·â€é¡µçš„æƒ…å†µä¸‹ï¼Œè¿™äº›å°é”ä¸ä¼šå‘ç”Ÿä»»ä½•é”ç«žäº‰

##### Buffer cache ðŸŸ¥

å¤šä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œbcache.lock ä¸Šä¼šå‘ç”Ÿä¸¥é‡çš„é”ç«žäº‰ã€‚bcache.lock é”ç”¨äºŽä¿æŠ¤ç£ç›˜åŒºå—ç¼“å­˜ï¼Œåœ¨åŽŸæœ¬çš„è®¾è®¡ä¸­ï¼Œç”±äºŽè¯¥é”çš„å­˜åœ¨ï¼Œå¤šä¸ªè¿›ç¨‹ä¸èƒ½åŒæ—¶æ“ä½œï¼ˆç”³è¯·ã€é‡Šæ”¾ï¼‰ç£ç›˜ç¼“å­˜ã€‚

å› ä¸ºä¸åƒ kalloc ä¸­ä¸€ä¸ªç‰©ç†é¡µåˆ†é…åŽå°±åªå½’å•ä¸ªè¿›ç¨‹æ‰€ç®¡ï¼Œbcache ä¸­çš„åŒºå—ç¼“å­˜æ˜¯ä¼šè¢«å¤šä¸ªè¿›ç¨‹ï¼ˆè¿›ä¸€æ­¥åœ°ï¼Œè¢«å¤šä¸ª CPUï¼‰å…±äº«çš„ï¼ˆç”±äºŽå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªåŒºå—ï¼‰ã€‚æ‰€ä»¥ kmem ä¸­ä¸ºæ¯ä¸ª CPU é¢„å…ˆåˆ†å‰²ä¸€éƒ¨åˆ†ä¸“å±žçš„é¡µçš„æ–¹æ³•åœ¨è¿™é‡Œæ˜¯è¡Œä¸é€šçš„ã€‚åœ¨è¿™é‡Œï¼Œ bcache å±žäºŽâ€œå¿…é¡»å…±äº«â€çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°ç¬¬äºŒä¸ªæ€è·¯ï¼Œé™ä½Žé”çš„ç²’åº¦ï¼Œç”¨æ›´ç²¾ç»†çš„é” scheme æ¥é™ä½Žå‡ºçŽ°ç«žäº‰çš„æ¦‚çŽ‡ã€‚

åŽŸç‰ˆ xv6 çš„è®¾è®¡ä¸­ï¼Œä½¿ç”¨åŒå‘é“¾è¡¨å­˜å‚¨æ‰€æœ‰çš„åŒºå—ç¼“å­˜ï¼Œæ¯æ¬¡å°è¯•èŽ·å–ä¸€ä¸ªåŒºå— blockno çš„æ—¶å€™ï¼Œä¼šéåŽ†é“¾è¡¨ï¼Œå¦‚æžœç›®æ ‡åŒºå—å·²ç»å­˜åœ¨ç¼“å­˜ä¸­åˆ™ç›´æŽ¥è¿”å›žï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™é€‰å–ä¸€ä¸ªæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„ï¼Œä¸”å¼•ç”¨è®¡æ•°ä¸º 0 çš„ buf å—ä½œä¸ºå…¶åŒºå—ç¼“å­˜ï¼Œå¹¶è¿”å›žã€‚æ–°çš„æ”¹è¿›æ–¹æ¡ˆï¼Œå¯ä»¥**å»ºç«‹ä¸€ä¸ªä»Ž blockno åˆ° buf çš„å“ˆå¸Œè¡¨ï¼Œå¹¶ä¸ºæ¯ä¸ªæ¡¶å•ç‹¬åŠ é”**ã€‚è¿™æ ·ï¼Œä»…æœ‰åœ¨ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®çš„åŒºå—åŒæ—¶å“ˆå¸Œåˆ°åŒä¸€ä¸ªæ¡¶çš„æ—¶å€™ï¼Œæ‰ä¼šå‘ç”Ÿé”ç«žäº‰ã€‚å½“æ¡¶ä¸­çš„ç©ºé—² buf ä¸è¶³çš„æ—¶å€™ï¼Œä»Žå…¶ä»–çš„æ¡¶ä¸­èŽ·å– bufã€‚

#### **Lab9 - File Systemï½œæ–‡ä»¶ç³»ç»Ÿï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** ä¸º xv6 çš„æ–‡ä»¶ç³»ç»Ÿæ·»åŠ å¤§æ–‡ä»¶ä»¥åŠç¬¦å·é“¾æŽ¥æ”¯æŒã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ§ðŸŸ§ 2 moderate
**ä¸ªäººè€—æ—¶ï¼š** 2 å°æ—¶

##### Large files ðŸŸ§

æœ¬ lab çš„ç›®æ ‡æ˜¯é€šè¿‡ä¸ºæ··åˆç´¢å¼•æœºåˆ¶æ·»åŠ äºŒçº§ç´¢å¼•é¡µï¼Œæ¥æ‰©å¤§èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¤§å°ã€‚

ä¸Ž FAT æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œxv6 æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ª inode ç»“æž„ä½“ä¸­ï¼Œé‡‡ç”¨äº†**æ··åˆç´¢å¼•**çš„æ–¹å¼è®°å½•æ•°æ®çš„æ‰€åœ¨å…·ä½“ç›˜å—å·ã€‚æ¯ä¸ªæ–‡ä»¶æ‰€å ç”¨çš„å‰ 12 ä¸ªç›˜å—çš„ç›˜å—å·æ˜¯ç›´æŽ¥è®°å½•åœ¨ inode ä¸­çš„ï¼ˆæ¯ä¸ªç›˜å— 1024 å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥å¯¹äºŽä»»ä½•æ–‡ä»¶çš„å‰ 12 KB æ•°æ®ï¼Œéƒ½å¯ä»¥é€šè¿‡è®¿é—® inode ç›´æŽ¥å¾—åˆ°ç›˜å—å·ã€‚è¿™ä¸€éƒ¨åˆ†ç§°ä¸ºç›´æŽ¥è®°å½•ç›˜å—ã€‚å¯¹äºŽå¤§äºŽ 12 ä¸ªç›˜å—çš„æ–‡ä»¶ï¼Œå¤§äºŽ 12 ä¸ªç›˜å—çš„éƒ¨åˆ†ï¼Œä¼šåˆ†é…ä¸€ä¸ªé¢å¤–çš„ä¸€çº§ç´¢å¼•è¡¨ï¼ˆä¸€ç›˜å—å¤§å°ï¼Œ1024Byteï¼‰ï¼Œç”¨äºŽå­˜å‚¨è¿™éƒ¨åˆ†æ•°æ®çš„æ‰€åœ¨ç›˜å—å·ã€‚

ç”±äºŽä¸€çº§ç´¢å¼•è¡¨å¯ä»¥åŒ…å« BSIZE(1024) / 4 = 256 ä¸ªç›˜å—å·ï¼ŒåŠ ä¸Š inode ä¸­çš„ 12 ä¸ªç›˜å—å·ï¼Œæ‰€ä»¥ä¸€ä¸ªæ–‡ä»¶æœ€å¤šå¯ä»¥ä½¿ç”¨ 12+256 = 268 ä¸ªç›˜å—ï¼Œä¹Ÿå°±æ˜¯ 268KBã€‚è€Œè¿™è¿œè¿œå°äºŽå¤§æ–‡ä»¶çš„éœ€æ±‚ï¼Œæ•…è€Œéœ€è¦æ·»åŠ äºŒçº§ç´¢å¼•é¡µ

é¦–å…ˆä¿®æ”¹ struct inodeï¼ˆå†…å­˜ä¸­çš„ inode å‰¯æœ¬ç»“æž„ä½“ï¼‰ä»¥åŠ struct dinodeï¼ˆç£ç›˜ä¸Šçš„ inode ç»“æž„ä½“ï¼‰ï¼Œå°† NDIRECT ç›´æŽ¥ç´¢å¼•çš„ç›˜å—å·å‡å°‘ 1ï¼Œè…¾å‡º inode ä¸­çš„ç©ºé—´æ¥å­˜å‚¨äºŒçº§ç´¢å¼•çš„ç´¢å¼•è¡¨ç›˜å—å·ã€‚ç„¶åŽä¿®æ”¹ bmapï¼ˆèŽ·å– inode ä¸­ç¬¬ bn ä¸ªå—çš„å—å·ï¼‰å’Œ itruncï¼ˆé‡Šæ”¾è¯¥ inode æ‰€ä½¿ç”¨çš„æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè®©å…¶èƒ½å¤Ÿè¯†åˆ«äºŒçº§ç´¢å¼•å³å¯ã€‚ï¼ˆåŸºæœ¬ä¸Šå’Œå¤åˆ¶ç²˜è´´ä¸€è‡´ï¼Œåªæ˜¯åœ¨æŸ¥å‡ºä¸€çº§å—å·åŽï¼Œéœ€å°†ä¸€çº§å—ä¸­çš„æ•°æ®è¯»å…¥ï¼Œç„¶åŽå†æ¬¡æŸ¥è¯¢ï¼‰

##### Symbolic links ðŸŸ§

å®žçŽ°ç¬¦å·é“¾æŽ¥æœºåˆ¶ã€‚é¦–å…ˆå®žçŽ° symlink ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºŽåˆ›å»ºç¬¦å·é“¾æŽ¥ã€‚ ç¬¦å·é“¾æŽ¥ä¸Žæ™®é€šçš„æ–‡ä»¶ä¸€æ ·ï¼Œéœ€è¦å ç”¨ inode å—ã€‚è¿™é‡Œä½¿ç”¨ inode ä¸­çš„ç¬¬ä¸€ä¸ª direct-mapped å—ï¼ˆ1024å­—èŠ‚ï¼‰æ¥å­˜å‚¨ç¬¦å·é“¾æŽ¥æŒ‡å‘çš„æ–‡ä»¶ã€‚ç„¶åŽä¿®æ”¹ sys_openï¼Œä½¿å…¶åœ¨é‡åˆ°ç¬¦å·é“¾æŽ¥çš„æ—¶å€™ï¼Œå¯ä»¥é€’å½’è·Ÿéšç¬¦å·é“¾æŽ¥ï¼Œç›´åˆ°è·Ÿéšåˆ°éžç¬¦å·é“¾æŽ¥çš„ inode ä¸ºæ­¢ã€‚

#### **Lab10 - Mmap | æ–‡ä»¶å†…å­˜æ˜ å°„ï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** å®žçŽ° *nix ç³»ç»Ÿè°ƒç”¨ mmap çš„ç®€å•ç‰ˆï¼šæ”¯æŒå°†æ–‡ä»¶æ˜ å°„åˆ°ä¸€ç‰‡ç”¨æˆ·è™šæ‹Ÿå†…å­˜åŒºåŸŸå†…ï¼Œå¹¶ä¸”æ”¯æŒå°†å¯¹å…¶çš„ä¿®æ”¹å†™å›žç£ç›˜ã€‚
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ¥ 1 hard
**ä¸ªäººè€—æ—¶ï¼š** 6 å°æ—¶

å®žçŽ° *nix ç³»ç»Ÿè°ƒç”¨ mmap çš„ç®€å•ç‰ˆï¼šæ”¯æŒå°†æ–‡ä»¶æ˜ å°„åˆ°ä¸€ç‰‡ç”¨æˆ·è™šæ‹Ÿå†…å­˜åŒºåŸŸå†…ï¼Œå¹¶ä¸”æ”¯æŒå°†å¯¹å…¶çš„ä¿®æ”¹å†™å›žç£ç›˜ã€‚

è¿™é‡Œæ¶‰åŠçš„æ“ä½œç³»ç»ŸåŸºæœ¬æ¦‚å¿µæ˜¯ã€Œè™šå­˜ã€ï¼Œmmap æŒ‡ä»¤é™¤äº†å¯ä»¥ç”¨æ¥å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸Šï¼Œè¿˜å¯ä»¥ç”¨æ¥å°†åˆ›å»ºçš„è¿›ç¨‹é—´å…±äº«å†…å­˜æ˜ å°„åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´å†…ã€‚æœ¬ lab åªéœ€å®žçŽ°å‰ä¸€åŠŸèƒ½å³å¯ã€‚

é¦–å…ˆéœ€è¦åœ¨ç”¨æˆ·çš„åœ°å€ç©ºé—´å†…ï¼Œæ‰¾åˆ°ä¸€ç‰‡ç©ºé—²çš„åŒºåŸŸï¼Œç”¨äºŽæ˜ å°„ mmap é¡µã€‚ä¸ºäº†å°½é‡ä½¿å¾— map çš„æ–‡ä»¶ä½¿ç”¨çš„åœ°å€ç©ºé—´ä¸è¦å’Œè¿›ç¨‹æ‰€ä½¿ç”¨çš„åœ°å€ç©ºé—´äº§ç”Ÿå†²çªï¼Œæˆ‘ä»¬é€‰æ‹©å°† mmap æ˜ å°„è¿›æ¥çš„æ–‡ä»¶ map åˆ°å°½å¯èƒ½é«˜çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯åˆšå¥½åœ¨ trapframe ä¸‹é¢ã€‚å¹¶ä¸”è‹¥æœ‰å¤šä¸ª mmap çš„æ–‡ä»¶ï¼Œåˆ™å‘ä¸‹ç”Ÿé•¿ã€‚æŽ¥ä¸‹æ¥å®šä¹‰ vma ç»“æž„ä½“ï¼Œå…¶ä¸­åŒ…å«äº† mmap æ˜ å°„çš„å†…å­˜åŒºåŸŸçš„å„ç§å¿…è¦ä¿¡æ¯ï¼Œæ¯”å¦‚å¼€å§‹åœ°å€ã€å¤§å°ã€æ‰€æ˜ å°„æ–‡ä»¶ã€æ–‡ä»¶å†…åç§»ä»¥åŠæƒé™ç­‰ã€‚æ­¤å¤–ï¼Œè®°å¾—åœ¨ proc ç»“æž„ä½“æœ«å°¾ä¸ºæ¯ä¸ªè¿›ç¨‹åŠ ä¸Š 16 ä¸ª vma ç©ºæ§½ã€‚

å®žçŽ° mmap ç³»ç»Ÿè°ƒç”¨ã€‚å‡½æ•°çš„åŠŸèƒ½æ˜¯åœ¨è¿›ç¨‹çš„ 16 ä¸ª vma æ§½ä¸­ï¼Œæ‰¾åˆ°å¯ç”¨çš„ç©ºæ§½ï¼Œå¹¶ä¸”é¡ºä¾¿è®¡ç®—æ‰€æœ‰ vma ä¸­ä½¿ç”¨åˆ°çš„æœ€ä½Žçš„è™šæ‹Ÿåœ°å€ï¼ˆä½œä¸ºæ–° vma çš„ç»“å°¾åœ°å€ vaendï¼Œå¼€åŒºé—´ï¼‰ï¼Œç„¶åŽå°†å½“å‰æ–‡ä»¶æ˜ å°„åˆ°è¯¥æœ€ä½Žåœ°å€ä¸‹é¢çš„ä½ç½®ï¼ˆvastart = vaend - szï¼‰ã€‚æœ€åŽè®°å¾—ä½¿ç”¨ `filedup(v->f);`ï¼Œå°†æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°å¢žåŠ ä¸€ã€‚

æ˜ å°„ä¹‹å‰ï¼Œéœ€è¦æ³¨æ„æ–‡ä»¶æƒé™çš„é—®é¢˜ï¼Œå¦‚æžœå°è¯•å°†ä¸€ä¸ªåªè¯»æ‰“å¼€çš„æ–‡ä»¶æ˜ å°„ä¸ºå¯å†™ï¼Œå¹¶ä¸”å¼€å¯äº†å›žç›˜ï¼ˆMAP_SHAREDï¼‰ï¼Œåˆ™ mmap åº”è¯¥å¤±è´¥ã€‚å¦åˆ™å›žç›˜çš„æ—¶å€™ä¼šå‡ºçŽ°å›žç›˜åˆ°ä¸€ä¸ªåªè¯»æ–‡ä»¶çš„é”™è¯¯æƒ…å†µã€‚

ç”±äºŽéœ€è¦å¯¹æ˜ å°„çš„é¡µå®žè¡Œæ‡’åŠ è½½ï¼Œä»…åœ¨è®¿é—®åˆ°çš„æ—¶å€™æ‰ä»Žç£ç›˜ä¸­åŠ è½½å‡ºæ¥ï¼Œæ•…è€Œä¸‹é¢å®žçŽ° munmap è°ƒç”¨ï¼Œå°†ä¸€ä¸ª vma æ‰€åˆ†é…çš„æ‰€æœ‰é¡µé‡Šæ”¾ï¼Œå¹¶åœ¨å¿…è¦çš„æƒ…å†µä¸‹ï¼Œå°†å·²ç»ä¿®æ”¹çš„é¡µå†™å›žç£ç›˜ã€‚

è¿™é‡Œé¦–å…ˆé€šè¿‡ä¼ å…¥çš„åœ°å€æ‰¾åˆ°å¯¹åº”çš„ vma ç»“æž„ä½“ï¼ˆé€šè¿‡å‰é¢å®šä¹‰çš„ findvma æ–¹æ³•ï¼‰ï¼Œç„¶åŽæ£€æµ‹äº†ä¸€ä¸‹åœ¨ vma åŒºåŸŸä¸­é—´â€œæŒ–æ´žâ€é‡Šæ”¾çš„é”™è¯¯æƒ…å†µï¼Œè®¡ç®—å‡ºåº”è¯¥å¼€å§‹é‡Šæ”¾çš„å†…å­˜åœ°å€ä»¥åŠåº”è¯¥é‡Šæ”¾çš„å†…å­˜å­—èŠ‚æ•°é‡ï¼ˆç”±äºŽé¡µæœ‰å¯èƒ½ä¸æ˜¯å®Œæ•´é‡Šæ”¾ï¼Œå¦‚æžœ addr å¤„äºŽä¸€ä¸ªé¡µçš„ä¸­é—´ï¼Œåˆ™é‚£ä¸ªé¡µçš„åŽåŠéƒ¨åˆ†é‡Šæ”¾ï¼Œä½†æ˜¯å‰åŠéƒ¨åˆ†ä¸é‡Šæ”¾ï¼Œæ­¤æ—¶è¯¥é¡µæ•´ä½“ä¸åº”è¯¥è¢«é‡Šæ”¾ï¼‰ã€‚

è®¡ç®—å‡ºæ¥é‡Šæ”¾å†…å­˜é¡µçš„å¼€å§‹åœ°å€ä»¥åŠé‡Šæ”¾çš„ä¸ªæ•°åŽï¼Œè°ƒç”¨è‡ªå®šä¹‰çš„ vmaunmap æ–¹æ³•ï¼ˆvm.cï¼‰å¯¹ç‰©ç†å†…å­˜é¡µè¿›è¡Œé‡Šæ”¾ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™å°†æ•°æ®å†™å›žç£ç›˜ã€‚å°†è¯¥æ–¹æ³•ç‹¬ç«‹å‡ºæ¥å¹¶å†™åˆ° vm.c ä¸­çš„ç†ç”±æ˜¯æ–¹ä¾¿è°ƒç”¨ vm.c ä¸­çš„ walk æ–¹æ³•ã€‚

åœ¨è°ƒç”¨ vmaunmap é‡Šæ”¾å†…å­˜é¡µä¹‹åŽï¼Œå¯¹ v->offsetã€v->vastart ä»¥åŠ v->sz ä½œç›¸åº”çš„ä¿®æ”¹ï¼Œå¹¶åœ¨æ‰€æœ‰é¡µé‡Šæ”¾å®Œæ¯•ä¹‹åŽï¼Œå…³é—­å¯¹æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¹¶å®Œå…¨é‡Šæ”¾è¯¥ vmaã€‚è¿™é‡Œçš„å®žçŽ°å¤§è‡´ä¸Šå’Œ uvmunmap ç›¸ä¼¼ï¼ŒæŸ¥æ‰¾èŒƒå›´å†…çš„æ¯ä¸€ä¸ªé¡µï¼Œæ£€æµ‹å…¶ dirty bit (D) æ˜¯å¦è¢«è®¾ç½®ï¼Œå¦‚æžœè¢«è®¾ç½®ï¼Œåˆ™ä»£è¡¨è¯¥é¡µè¢«ä¿®æ”¹è¿‡ï¼Œéœ€è¦å°†å…¶å†™å›žç£ç›˜ã€‚æ³¨æ„ä¸æ˜¯æ¯ä¸€ä¸ªé¡µéƒ½éœ€è¦å®Œæ•´çš„å†™å›žï¼Œè¿™é‡Œéœ€è¦å¤„ç†å¼€å¤´é¡µä¸å®Œæ•´ã€ç»“å°¾é¡µä¸å®Œæ•´ä»¥åŠä¸­é—´å®Œæ•´é¡µçš„æƒ…å†µã€‚

æœ€åŽéœ€è¦åšçš„ï¼Œæ˜¯åœ¨ proc.c ä¸­æ·»åŠ å¤„ç†è¿›ç¨‹ vma çš„å„éƒ¨åˆ†ä»£ç ã€‚

- è®© allocproc åˆå§‹åŒ–è¿›ç¨‹çš„æ—¶å€™ï¼Œå°† vma æ§½éƒ½æ¸…ç©º
- freeproc é‡Šæ”¾è¿›ç¨‹æ—¶ï¼Œè°ƒç”¨ vmaunmap å°†æ‰€æœ‰ vma çš„å†…å­˜éƒ½é‡Šæ”¾ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™å†™å›žç£ç›˜
- fork æ—¶ï¼Œæ‹·è´çˆ¶è¿›ç¨‹çš„æ‰€æœ‰ vmaï¼Œä½†æ˜¯ä¸æ‹·è´ç‰©ç†é¡µ

#### **Lab11 - Network stackï¼š**

**ç›®æ ‡ç®€è¿°ï¼š** ç†Ÿæ‚‰ç³»ç»Ÿé©±åŠ¨ä¸Žå¤–å›´è®¾å¤‡çš„äº¤äº’ã€å†…å­˜æ˜ å°„å¯„å­˜å™¨ä¸Ž DMA æ•°æ®ä¼ è¾“ï¼Œå®žçŽ°ä¸Ž E1000 ç½‘å¡äº¤äº’çš„æ ¸å¿ƒæ–¹æ³•ï¼štransmit ä¸Ž recvã€‚ ï¼ˆæœ¬ lab çš„éš¾åº¦ä¸»è¦åœ¨äºŽé˜…è¯»æ–‡æ¡£ä»¥åŠç†è§£ CPU ä¸Žæ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•ä¸Žå¤–å›´è®¾å¤‡äº¤äº’çš„ã€‚æ¢è¨€ä¹‹ï¼Œæ›´é‡è¦çš„æ˜¯ç†è§£æ¦‚å¿µä»¥åŠ lab å·²ç»å†™å¥½çš„æ¨¡ç‰ˆä»£ç çš„ä½œç”¨ã€‚ï¼‰
**å®žéªŒéš¾åº¦ï¼š** ðŸŸ¥ 1 hard
**ä¸ªäººè€—æ—¶ï¼š** 3 å°æ—¶

æ“ä½œç³»ç»Ÿæƒ³è¦å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå°†æ•°æ®æ”¾å…¥çŽ¯å½¢ç¼“å†²åŒºæ•°ç»„ tx_ring å†…ï¼Œç„¶åŽé€’å¢ž E1000_TDTï¼Œç½‘å¡ä¼šè‡ªåŠ¨å°†æ•°æ®å‘å‡ºã€‚å½“ç½‘å¡æ”¶åˆ°æ•°æ®çš„æ—¶å€™ï¼Œç½‘å¡é¦–å…ˆä½¿ç”¨ direct memory accessï¼Œå°†æ•°æ®æ”¾å…¥ rx_ring çŽ¯å½¢ç¼“å†²åŒºæ•°ç»„ä¸­ï¼Œç„¶åŽå‘ CPU å‘èµ·ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ï¼ŒCPU åœ¨æ”¶åˆ°ä¸­æ–­åŽï¼Œç›´æŽ¥è¯»å– rx_ring ä¸­çš„æ•°æ®å³å¯ã€‚

# æ„Ÿæƒ³(Summary)

â€‹	åœ¨é€šè¿‡æœ€åŽä¸€ä¸ªnetçš„æµ‹è¯•æ—¶ï¼Œä¸€ç§å‰æ‰€æœªæœ‰çš„è½»æ¾æ„Ÿé¡¿æ—¶å¸­å·äº†æˆ‘çš„å…¨èº«ï¼Œé‚£ç§æ·±å…¥äº†è§£è®¡ç®—æœºç³»ç»Ÿå†…éƒ¨æ˜¯å¦‚ä½•ä¸Žç”¨æˆ·è¿›è¡Œäº¤äº’ï¼Œä¸Žç¡¬ä»¶è¿›è¡Œé€šä¿¡ä»¥åŠåœ¨ç¨‹åºé—´è¿›è¡Œè°ƒåº¦çš„æ„Ÿè§‰ç®€ç›´æ— ä¸Žä¼¦æ¯”ã€‚è¿˜è®°å¾—ç¬¬ä¸€æ¬¡æŽ¥è§¦Unixä¸­ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¥è¡¨ç¤ºä¸€åˆ‡çš„æŠ½è±¡æ—¶ï¼Œé‚£ç§å·§å¦™è€Œåˆç¥žå¥‡çš„è®¾è®¡ç»™äº†æˆ‘å·¨å¤§çš„éœ‡æ’¼ã€‚

â€‹	åœ¨æ•´ä¸ªlabçš„å®Œæˆè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œæœ‰äº›ä»£ç è¡Œä½“çŽ°äº†ä¸»è¦æ€æƒ³çš„æœ¬è´¨ï¼ˆä¾‹å¦‚ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€ç”¨æˆ·/å†…æ ¸è¾¹ç•Œã€é”ç­‰ï¼‰ï¼Œå¹¶ä¸”æ¯ä¸€è¡Œéƒ½å¾ˆé‡è¦ï¼›å…¶ä»–ä»£ç è¡Œæä¾›äº†å¦‚ä½•å®žçŽ°ç‰¹å®šæ“ä½œç³»ç»Ÿæƒ³æ³•çš„è¯´æ˜Žï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼è½»æ¾å®Œæˆï¼ˆä¾‹å¦‚ï¼Œæ›´å¥½çš„è°ƒåº¦ç®—æ³•ã€æ›´å¥½çš„ç£ç›˜æ•°æ®ç»“æž„æ¥è¡¨ç¤ºæ–‡ä»¶ã€æ›´å¥½çš„æ—¥å¿—è®°å½•ä»¥å…è®¸å¹¶å‘äº‹åŠ¡ç­‰ç­‰ï¼‰ã€‚æ‰€æœ‰çš„æƒ³æ³•éƒ½æ˜¯åœ¨ä¸€ä¸ªç‰¹å®šçš„ã€éžå¸¸æˆåŠŸçš„ç³»ç»Ÿè°ƒç”¨æŽ¥å£ï¼ˆUnix æŽ¥å£ï¼‰çš„èƒŒæ™¯ä¸‹é˜è¿°çš„ï¼Œä½†è¿™äº›æƒ³æ³•ä¹Ÿå»¶ç»­åˆ°äº†å…¶ä»–æ“ä½œç³»ç»Ÿçš„è®¾è®¡ä¸­ã€‚

â€‹	å½“ç„¶ï¼Œæ“ä½œç³»ç»Ÿçš„å†…å®¹è¿˜å¾ˆå¤šï¼Œæˆ‘çš„è·¯ä¹Ÿè¿˜å¾ˆé•¿ï¼Œxv6è™½ç„¶ç²¾å·§ä½†ä¹Ÿä¸è¿‡æ˜¯å¾ˆç®€æ˜“çš„ç³»ç»Ÿå†…æ ¸ï¼ŒçŽ°ä»£OSçš„å¾ˆå¤šæ€æƒ³å’Œç®—æ³•ä¹Ÿç­‰ç€æˆ‘åŽ»æŽ¢ç´¢ï¼Œæ‰€ä»¥ï¼Œå°‘å¹´ï¼š

>â€‹		æ‰€è°“æ— åº•æ·±æ¸Šï¼Œèµ°ä¸‹åŽ»ï¼Œä¹Ÿæ˜¯å‰ç¨‹ä¸‡é‡Œ
>
>â€‹							â€”â€” æœ¨å¿ƒ

# é™„å½•(Appendix)

[6.S081: Operating System Engineering/schedule](https://pdos.csail.mit.edu/6.S081/2020/schedule.html)

[MIT 6.S081 lecture notes gitbook](https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081)

[Miigonâ€™s blog MIT 6.S081 è¯¾ç¨‹æ€»ç»“ & Lab æŒ‡åŒ—](https://blog.miigon.net/posts/s081-ending/)